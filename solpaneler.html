<!DOCTYPE html>
<html lang="es">
<head>

<meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nordvolt Solar</title>
  
  <!-- Bootstrap & FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />  

  <!-- Theme Color -->
  <meta name="theme-color" content="#22c55e">

  <style>  

  :root {
  /* === TEMA-VARIABLER - √ÑNDRA DESSA F√ñR NYA TEMAN === */
  
  /* Huvudf√§rger */
  --primary-green: #22c55e;
  --secondary-green: #16a34a;
  --accent-yellow: #fbbf24;
  --solar-orange: #f97316;
  --energy-blue: #0284c7;
  
  /* Bakgrunder */
  --white: #ffffff;
  --light-gray: #f8fafc;
  --border-gray: #e2e8f0;
  
  /* Text */
  --text-dark: #1e293b;
  --text-light: #64748b;
  
  /* Gradienter */
  --gradient-bg: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
  --solar-gradient: linear-gradient(135deg, var(--accent-yellow) 0%, var(--solar-orange) 100%);
  
  /* Skuggor */
  --shadow: 0 4px 20px rgba(34, 197, 94, 0.15);
  --glow: 0 0 20px rgba(251, 191, 36, 0.3);
  
  /* F√∂retagsspecifikt - √ÑNDRA DETTA F√ñR OLIKA KUNDER */
  --company-name: "Nordvolt Solar";
  --company-tagline: "Framtidens energi f√∂r ditt hem";
  --agent-name: "Emma";
  --agent-greeting: "Hej, jag heter Emma!";
  --agent-description: "Expert p√• solenergi - prata med mig";
  
  /* Typografi */
  --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --border-radius: 15px;  
}

     

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--light-gray);
      color: var(--text-dark);
      line-height: 1.6;
      overflow-x: hidden;
    }

    .app-container {
      max-width: 414px;
      margin: 0 auto;
      background: var(--white);
      min-height: 100vh;
      box-shadow: 0 0 40px rgba(0,0,0,0.1);
      position: relative;
    }

    /* Header */
    .app-header {
      background: var(--gradient-bg);
      padding: 40px 20px 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .app-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="solar" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="2" fill="rgba(255,255,255,0.1)"/><path d="M10 2 L10 18 M2 10 L18 10 M5 5 L15 15 M15 5 L5 15" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23solar)"/></svg>') repeat;
      animation: solarPulse 4s ease-in-out infinite;
      opacity: 0.3;
    }

    @keyframes solarPulse {
      0%, 100% { transform: scale(1); opacity: 0.3; }
      50% { transform: scale(1.05); opacity: 0.5; }
    }

    .app-title {
      color: var(--white);
      font-size: 2.4rem;
      font-weight: 700;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .app-subtitle {
      color: rgba(255,255,255,0.95);
      font-size: 1.1rem;
      font-weight: 500;
      position: relative;
      z-index: 1;
    }

    /* Voice Agent */
    .voice-agent {
      background: var(--white);
      margin: -20px 20px 20px;
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 20px;
      text-align: center;
      position: relative;
      z-index: 2;
      border: 2px solid rgba(34, 197, 94, 0.1);
    }

    .agent-avatar {
      width: 70px;
      height: 70px;
      background: var(--solar-gradient);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 1.8rem;
      color: var(--white);
      box-shadow: var(--glow);
      animation: solarGlow 2s ease-in-out infinite alternate;
    }

    @keyframes solarGlow {
      0% { box-shadow: var(--glow); }
      100% { box-shadow: 0 0 30px rgba(251, 191, 36, 0.5); }
    }

    .agent-greeting {
      font-size: 1.2rem;
      color: var(--text-dark);
      margin-bottom: 16px;
      font-weight: 600;
    }

    /* Solar Panel Gallery Section */
    .content-section {
      padding: 0 16px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .section-icon {
      width: 45px;
      height: 45px;
      background: var(--solar-gradient);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-size: 1.3rem;
      box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
    }

    .section-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-dark);
    }

    .category-selector {
      background: var(--white);
      border: 2px solid var(--border-gray);
      border-radius: 16px;
      padding: 16px;
      font-size: 1rem;
      width: 100%;
      margin-bottom: 24px;
      transition: all 0.3s ease;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2322c55e' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 16px center;
      background-repeat: no-repeat;
      background-size: 16px;
      padding-right: 48px;
      font-weight: 500;
    }

    .category-selector:focus {
      outline: none;
      border-color: var(--primary-green);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }

    /* Carousel */
    .solar-carousel {
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--shadow);
      margin-bottom: 30px;
      border: 2px solid rgba(34, 197, 94, 0.1);
    }

    .carousel-item {
      height: 300px;
      position: relative;
    }

    .carousel-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
      cursor: pointer;
    }

    .carousel-item:hover img {
      transform: scale(1.03);
    }

    .solar-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      color: var(--white);
      padding: 50px 20px 20px;
    }

    .solar-name {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .solar-features {
      font-size: 1rem;
      opacity: 0.95;
      color: #fbbf24;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Hide any lightning bolt icons that might appear */
    .carousel-item .fa-bolt,
    .carousel-item .fas.fa-bolt,
    .solar-info .fa-bolt,
    .solar-info .fas.fa-bolt {
      display: none !important;
    }

    /* Hide any yellow circular elements in carousel */
    .carousel-item::before,
    .carousel-item::after,
    .solar-info::before,
    .solar-info::after {
      display: none !important;
    }

    .carousel-control-prev,
    .carousel-control-next {
      width: 55px;
      height: 55px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.95);
      border-radius: 50%;
      border: none;
      backdrop-filter: blur(15px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .carousel-control-prev {
      left: 15px;
    }

    .carousel-control-next {
      right: 15px;
    }

    .carousel-control-prev-icon,
    .carousel-control-next-icon {
      background-size: 22px;
      width: 22px;
      height: 22px;
      filter: invert(1);
    }

    .carousel-indicators {
      bottom: 20px;
    }

    .carousel-indicators button {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: none;
      margin: 0 5px;
      background: rgba(255,255,255,0.6);
    }

    .carousel-indicators button.active {
      background: var(--accent-yellow);
      box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
    }

    /* Chat Section */
    .chat-section {
      background: var(--white);      
      margin: 0 16px 20px;
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 2px solid rgba(34, 197, 94, 0.1);
    }

    .chat-header {
      background: var(--gradient-bg);
      height: 70px;
      padding: 20px;
      text-align: center;
    }

    .chat-title {
      color: var(--white);
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .chat-subtitle {
      color: rgba(255,255,255,0.9);
      font-size: 1rem;
      font-weight: 500;
    }

    .chat-content {
      padding: 24px;
    }

    .agent-response {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 18px;
      min-height: 65px;
      font-size: 1rem;
      line-height: 1.6;
      border-left: 4px solid var(--primary-green);
      position: relative;
      overflow: hidden;
    }

    .agent-response.loading {
      background: linear-gradient(90deg, #f0f9ff 25%, #e0f2fe 50%, #f0f9ff 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    .agent-response a {
      color: var(--primary-green);
      text-decoration: none;
      font-weight: 600;
      padding: 10px 18px;
      background: rgba(34, 197, 94, 0.1);
      border-radius: 10px;
      display: inline-block;
      margin: 6px 0;
      transition: all 0.3s ease;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .agent-response a:hover {
      background: var(--primary-green);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .input-group {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      background: var(--light-gray);
      border: 2px solid var(--border-gray);
      border-radius: 24px;
      padding: 14px 18px;
      font-size: 1rem;
      resize: none;
      max-height: 120px;
      transition: all 0.3s ease;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--primary-green);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }

    .send-button {
      width: 52px;
      height: 52px;
      background: var(--gradient-bg);
      border: none;
      border-radius: 50%;
      color: var(--white);
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
    }

    .send-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
    }

    .send-button:active {
      transform: translateY(-1px);
    }

    /* Footer */
    .app-footer {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-light);
      font-size: 0.95rem;
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 25px;
      margin-bottom: 20px;
    }

    .footer-links a {
      color: var(--primary-green);
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s ease;
    }

    .footer-links a:hover {
      color: var(--secondary-green);
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      .app-container {
        max-width: 100%;
      }
      
      .app-header {
        padding: 50px 16px 30px;
      }
      
      .content-section {
        padding: 0 16px;
      }
      
      .voice-agent,
      .chat-section {
        margin-left: 16px;
        margin-right: 16px;
      }
    }

    /* Floating elements animation */
    .floating {
      animation: float 4s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-12px); }
    }

    /* Success states */
    .success-feedback {
      background: var(--gradient-bg);
      color: white;
      padding: 14px 18px;
      border-radius: 14px;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
    }

    /* Loading animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Energy efficiency badges */
    .energy-badge {
      background: var(--solar-gradient);
      color: var(--white);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
      margin-left: 8px;
    }

    /* Improved image styling */
    img {
      max-width: 100%;
      height: auto;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }

    /* Camera Button Styles */
    #camera-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 5px;
        transition: all 0.3s ease;
    }

    #camera-btn:hover {
        background: #5a67d8;
        transform: scale(1.05);
    }

    /* Camera Modal Styles */
    .camera-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .camera-modal.active {
        display: flex;
    }

    /* Camera Frame Container */
    .camera-frame {
        position: relative;
        width: 90%;
        height: 90%;
        max-width: 500px;
        max-height: 800px;
        border-radius: 15px;
        overflow: hidden;
    }

    /* Camera Iframe */
    .camera-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
    }

    /* Close Button */
    .close-camera-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        border: none;
        color: white;
        font-size: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .close-camera-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    /* Mobile Responsive */
    @media only screen and (max-width: 768px) {
        .camera-frame {
            width: 95%;
            height: 95%;
        }
        
        .close-camera-btn {
            top: 10px;
            right: 10px;
            width: 35px;
            height: 35px;
            font-size: 18px;
        }
    }

    /* === TEMA-BASERADE TEXTF√ÑLT === */
.company-name::after {
  content: var(--company-name);
}

.company-tagline::after {
  content: var(--company-tagline);
}

.agent-greeting::after {
  content: var(--agent-greeting);
}

.agent-description {
  color: var(--text-light);
  margin-bottom: 20px;
}

.agent-description::after {
  content: var(--agent-description);
}

/* D√∂lj ursprunglig text */
.company-name,
.company-tagline,
.agent-greeting {
  font-size: 0;
}

.company-name::after,
.company-tagline::after,
.agent-greeting::after {
  font-size: initial;
}


/* === TEMA-BASERADE TEXTF√ÑLT === */
.company-name {
  font-size: 0;
}

.company-name::after {
  content: var(--company-name);
  font-size: 2.4rem;
  font-weight: 700;
  color: var(--white);
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.company-tagline {
  font-size: 0;
}

.company-tagline::after {
  content: var(--company-tagline);
  font-size: 1.1rem;
  font-weight: 500;
  color: rgba(255,255,255,0.95);
}

.agent-greeting {
  font-size: 0;
}

.agent-greeting::after {
  content: var(--agent-greeting);
  font-size: 1.2rem;
  color: var(--text-dark);
  margin-bottom: 16px;
  font-weight: 600;
}

.agent-description {
  font-size: 0;
  color: var(--text-light);
  margin-bottom: 20px;
}

.agent-description::after {
  content: var(--agent-description);
  font-size: 1rem;
}
</style>

</head>

<body>

  <div class="app-container">
    
    <!-- Header -->
    <header class="app-header">        
      
     <h1 class="app-title">
       <i class="fas fa-solar-panel"></i>
       <span class="company-name">Nordvolt Solar</span>
    </h1>
    <p class="app-subtitle company-tagline">Framtidens energi f√∂r ditt hem</p> 

    </header>

    <!-- Voice Agent -->
    <div class="voice-agent floating">
      <div class="agent-avatar">
        <i class="fas fa-sun"></i>
      </div>

     <h3 class="agent-greeting">Hej, jag heter Emma!</h3>
     <p class="agent-description">Expert p√• solenergi - prata med mig</p> 

      <elevenlabs-convai agent-id="agent_2701k1617cvzeybvwt785svpfwby"></elevenlabs-convai>
    </div> 
    
    <!-- Solar Panel Gallery Section -->
    <section class="content-section">
      <div class="section-header">
        <div class="section-icon">
          <i class="fas fa-solar-panel"></i>
        </div>
        <h2 class="section-title">V√•ra Soll√∂sningar</h2>
      </div>
      
      <select id="productSelector" class="category-selector" onchange="handleCategoryChange(this.value)">
        <option value="" selected disabled>KARUSELL: V√ÑLJ KATEGORI</option>
        <option value="starter-solar" title="Perfekt f√∂r dig som vill b√∂rja sm√•tt och testa solenergi.">
          ‚òÄÔ∏è Startpaket f√∂r ditt hem
        </option>
        <option value="max-performance" title="F√∂r hem som vill vara s√• sj√§lvf√∂rs√∂rjande som m√∂jligt.">
          üîã Maximal prestanda och sj√§lvf√∂rs√∂rjning
        </option>
        <option value="offgrid-package" title="Idealiskt f√∂r stugor och platser utan eln√§t - off-grid l√∂sning.">
          üå≤ Paket f√∂r fritidshus och off-grid
        </option>    
      </select>
     
      <div id="carouselWrapper"></div>
    </section>

    <!-- Chat Section -->
    <section class="chat-section">
      <div class="chat-header">
        <h3 class="chat-title">
          <i class="fas fa-comments"></i>
          Skriv till Emma
        </h3>
        <p class="chat-subtitle">.</p>
      </div>
      
      <div class="chat-content">
        <div id="agentResponse" class="agent-response">
          <i class="fas fa-sun" style="color: var(--solar-orange);"></i>
          Emma svarar...
        </div>
        
        <div class="input-group">
          <textarea 
            id="chatInput" 
            class="chat-input" 
            placeholder="Skicka meddelande..." 
            rows="1"
          ></textarea>
          <button id="sendBtn" class="send-button" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </section>

    <!-- Camera Button -->
    <button id="camera-btn" onclick="openGenericCamera()" title="Ta foto f√∂r analys">
      üì∏
    </button>   
  

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>
 
  <script>
    
// =============================================================================
// CONFIGURATION & CONSTANTS
// =============================================================================

// Your real n8n endpoint
const AGENT_URL = "https://tangosweden.app.n8n.cloud/webhook/webhook-chat";


// =============================================================================
// INITIALIZATION & EVENT LISTENERS
// =============================================================================

// Auto-resize textarea functionality
const chatInput = document.getElementById("chatInput");
if (chatInput) {
  chatInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
  });
}

// Enter key support for chat
document.getElementById("chatInput").addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});


// MULTIMEDIA: KOMPLETT VIDEO & IMAGE PROCESSING - FIXAD VERSION
// =============================================================================

// Centralized N8N response parsing - FIXAD F√ñR DUBBEL JSON STRINGIFIERING
function parseN8nResponse(result) {
  console.log("parseN8nResponse received:", result);
  
  let output;
  
  // Extrahera output fr√•n n8n response
  if (Array.isArray(result) && result[0]?.output) {
    output = result[0].output;
  } else if (result?.output) {
    output = result.output;
  } else if (typeof result === "string") {
    output = result;
  } else {
    console.error("Unknown response format:", result);
    return "Tekniskt fel - kontakta support.";
  }
  
  console.log("Extracted output:", output);
  console.log("Output type:", typeof output);
  
  // ‚≠ê F√ñRB√ÑTTRAD HANTERING - DUBBEL JSON STRINGIFIERING
  if (typeof output === "string") {
    try {
      // F√ñRSTA PARSING - Fr√•n str√§ng till JSON
      console.log("Attempting first JSON parse...");
      let firstParse = JSON.parse(output);
      console.log("First parse result:", firstParse);
      console.log("First parse type:", typeof firstParse);
      
      // Om f√∂rsta parsingen ger en str√§ng som ocks√• √§r JSON, parsa igen
      if (typeof firstParse === "string" && 
          (firstParse.includes('"title"') || firstParse.startsWith('{'))) {
        console.log("Attempting second JSON parse...");
        let secondParse = JSON.parse(firstParse);
        console.log("Second parse result:", secondParse);
        
        // Validera att det √§r r√§tt struktur
        if (secondParse.title && (secondParse.introduction || secondParse.points)) {
          console.log("‚úÖ Valid content card structure found after double parsing");
          return secondParse; // Returnera som objekt
        }
        
        return secondParse;
      }
      
      // Om f√∂rsta parsingen redan gav ett objekt
      if (typeof firstParse === "object" && firstParse !== null) {
        if (firstParse.title && (firstParse.introduction || firstParse.points)) {
          console.log("‚úÖ Valid content card structure found after single parsing");
          return firstParse;
        }
        return firstParse;
      }
      
      // Annars returnera f√∂rsta parsingen
      return firstParse;
      
    } catch (e) {
      console.error("JSON parsing failed:", e);
      console.log("Returning as plain text");
      return output;
    }
  }
  
  // Om output redan √§r ett objekt
  if (typeof output === "object" && output !== null) {
    console.log("Output is already an object");
    return output;
  }
  
  console.log("Returning as regular text");
  return output;
}

// Centralized loading state management
function setLoadingState(element, isLoading, loadingText = "Laddar...") {
  if (isLoading) {
    element.classList.add("loading");
    element.innerHTML = `
      <i class="fas fa-sun" style="color: var(--solar-orange);"></i>
      <span style="margin-left: 10px;">${loadingText}</span>
    `;
  } else {
    element.classList.remove("loading");
  }
}

// =============================================================================
// HJ√ÑLPFUNKTIONER F√ñR JSON-KORT - M√ÖSTE KOMMA F√ñRE processUrls
// =============================================================================

// Kompakt inneh√•llskort utan knapp
function createContentCard(data) {
  console.log("createContentCard called with:", data);
  
  // S√§kerst√§ll att points √§r en array
  let points = data.points;
  if (typeof points === 'string') {
    points = points.split('\n').filter(p => p.trim());
  } else if (!Array.isArray(points)) {
    points = [];
  }
  
  // S√§kerst√§ll att advantages √§r en array om den finns
  let advantages = data.advantages;
  if (typeof advantages === 'string') {
    advantages = advantages.split('\n').filter(a => a.trim());
  } else if (!Array.isArray(advantages)) {
    advantages = [];
  }
  
  return `
    <div style="margin: 15px 0; background: #f8fafc; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: 1px solid rgba(34, 197, 94, 0.2);">
      
      <!-- Header -->
      <div style="background: var(--gradient-bg); padding: 12px 16px; text-align: center;">
        <h3 style="color: white; margin: 0; font-size: 1.1rem; font-weight: 600;">
          üìä ${data.title}
        </h3>
      </div>
      
      <!-- Content -->
      <div style="padding: 16px;">
        
        <!-- Introduction -->
        ${data.introduction ? `
          <div style="background: rgba(34, 197, 94, 0.08); padding: 10px 12px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid var(--primary-green);">
            <span style="color: var(--text-dark); font-size: 0.95rem; font-weight: 500; font-style: italic;">
              üí¨ ${data.introduction}
            </span>
          </div>
        ` : ''}
        
        <!-- Main Points -->
        ${points && points.length > 0 ? `
          <div style="margin-bottom: 12px;">
            <ul style="margin: 0; padding: 0; list-style: none; line-height: 1.3;">
              ${points.map((point) => `
                <li style="margin: 6px 0; padding: 8px 10px; background: rgba(251, 191, 36, 0.06); border-radius: 6px; border-left: 2px solid var(--accent-yellow); display: flex; align-items: flex-start; gap: 8px; font-size: 0.9rem;">
                  <span style="color: var(--accent-yellow); font-weight: bold; font-size: 0.9rem; flex-shrink: 0; margin-top: 1px;">‚Ä¢</span>
                  <span style="color: var(--text-dark); line-height: 1.3;">${point}</span>
                </li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
        
        <!-- Advantages -->
        ${data.advantages_title && advantages && advantages.length > 0 ? `
          <div style="background: rgba(14, 165, 233, 0.06); padding: 12px; border-radius: 8px; border: 1px solid rgba(14, 165, 233, 0.15);">
            <h4 style="margin: 0 0 8px 0; color: var(--energy-blue); font-size: 0.95rem; font-weight: 600;">
              ‚≠ê ${data.advantages_title}
            </h4>
            <ul style="margin: 0; padding: 0; list-style: none; line-height: 1.3;">
              ${advantages.map(advantage => `
                <li style="margin: 4px 0; padding: 6px 8px; background: rgba(14, 165, 233, 0.04); border-radius: 4px; display: flex; align-items: flex-start; gap: 6px; font-size: 0.85rem;">
                  <span style="color: var(--energy-blue); font-weight: bold; font-size: 0.85rem; flex-shrink: 0; margin-top: 1px;">‚ñ∏</span>
                  <span style="color: var(--text-dark); line-height: 1.3;">${advantage}</span>
                </li>
              `).join('')}
            </ul>
          </div>
        ` : ''}
        
      </div>
    </div>
  `;
}

// Funktion f√∂r strukturerade bildkort
function createImageCard(data) {
  return `
    <div style="margin: 20px 0; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 20px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 2px solid rgba(34, 197, 94, 0.1);">
      ${data.title ? `
        <div style="background: var(--gradient-bg); padding: 15px; text-align: center;">
          <h3 style="color: white; margin: 0; font-size: 1.2rem; font-weight: 600;">
            üìä ${data.title}
          </h3>
        </div>
      ` : ''}
      
      <div style="padding: 20px; text-align: center;">
        <img src="${data.imageUrl}" 
             style="width: 100%; max-width: 600px; height: auto; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.3s ease;" 
             alt="${data.title || 'Bild'}"
             onclick="this.style.transform = this.style.transform ? '' : 'scale(1.1)'" />
        
        ${data.description ? `
          <p style="margin: 15px 0 10px 0; color: var(--text-dark); font-size: 1.1rem; font-weight: 600;">
            ${data.description}
          </p>
        ` : ''}
      </div>
    </div>
  `;
}

// Funktion f√∂r strukturerade videokort
function createVideoCard(data) {
  const videoId = data.videoUrl.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/)?.[1];
  
  return `
    <div style="margin: 20px 0; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 20px; overflow: hidden; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 2px solid rgba(34, 197, 94, 0.1);">
      ${data.title ? `
        <div style="background: var(--gradient-bg); padding: 15px; text-align: center;">
          <h3 style="color: white; margin: 0; font-size: 1.2rem; font-weight: 600;">
            üé• ${data.title}
          </h3>
        </div>
      ` : ''}
      
      <div style="padding: 20px;">
        ${videoId ? `
          <div style="border-radius: 15px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
            <iframe width="100%" height="250" src="https://www.youtube.com/embed/${videoId}" 
              frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
              allowfullscreen style="border-radius: 15px;"></iframe>
          </div>
        ` : ''}
        
        ${data.description ? `
          <p style="margin: 15px 0; color: var(--text-dark); font-size: 1.1rem; text-align: center;">
            ${data.description}
          </p>
        ` : ''}
      </div>
    </div>
  `;
}

// =============================================================================
// MULTIMEDIA PROCESSING - F√ñRB√ÑTTRAD VERSION
// =============================================================================

// Multimedia: Video & Image processing - KOMPLETT F√ñRB√ÑTTRAD
function processUrls(agentText) {
  console.log("=== processUrls STARTED ===");
  console.log("Received:", agentText);
  console.log("Type:", typeof agentText);
  console.log("Is object:", typeof agentText === 'object');
  console.log("Is null:", agentText === null);
  console.log("Is array:", Array.isArray(agentText));
  
  // ‚≠ê F√ñRB√ÑTTRAD OBJEKT-HANTERING
  if (typeof agentText === 'object' && agentText !== null && !Array.isArray(agentText)) {
    console.log("‚úÖ Processing as JSON object");
    console.log("Object properties:", Object.keys(agentText));
    
    // Hantera inneh√•llskort (resultat, testimonials etc)
    if (agentText.title && (agentText.introduction || agentText.points)) {
      console.log("‚úÖ Object has required properties for content card");
      console.log("‚úÖ Calling createContentCard...");
      
      const result = createContentCard(agentText);
      console.log("‚úÖ createContentCard returned HTML");
      return result;
    }
    
    // Hantera strukturerade bildkort
    if (agentText.type === "image" && agentText.imageUrl) {
      console.log("‚úÖ Creating image card from object");
      return createImageCard(agentText);
    }
    
    // Hantera strukturerade videokort
    if (agentText.type === "video" && agentText.videoUrl) {
      console.log("‚úÖ Creating video card from object");
      return createVideoCard(agentText);
    }
    
    console.log("‚ùå Object missing required properties, converting to string");
    agentText = JSON.stringify(agentText, null, 2);
  }

  // ===== STR√ÑNG-HANTERING =====
  if (!agentText || typeof agentText !== "string") {
    console.log("‚ùå Invalid input, returning as-is");
    return agentText;
  }
  
  console.log("Processing as string:", agentText.substring(0, 100) + "...");

  // ===== JSON-STR√ÑNG PARSING MED DUBBEL PARSING =====
  if (agentText.trim().startsWith('{') && agentText.trim().endsWith('}')) {
    try {
      console.log("Attempting to parse JSON string");
      let jsonData = JSON.parse(agentText);
      
      // Om resultatet √§r en str√§ng som ocks√• √§r JSON, parsa igen
      if (typeof jsonData === "string" && 
          (jsonData.includes('"title"') || jsonData.startsWith('{'))) {
        console.log("Double-stringified JSON detected, parsing again...");
        jsonData = JSON.parse(jsonData);
      }
      
      // Hantera inneh√•llskort
      if (jsonData.title && (jsonData.introduction || jsonData.points)) {
        console.log("Creating content card from JSON string");
        return createContentCard(jsonData);
      }
      
      // Hantera strukturerade bildkort
      if (jsonData.type === "image" && jsonData.imageUrl) {
        console.log("Creating image card from JSON string");
        return createImageCard(jsonData);
      }
      
      // Hantera strukturerade videokort
      if (jsonData.type === "video" && jsonData.videoUrl) {
        console.log("Creating video card from JSON string");
        return createVideoCard(jsonData);
      }
      
    } catch (e) {
      console.log("JSON parsing failed:", e);
    }
  }

  // ===== URL-HANTERING =====
  console.log("Processing as regular URLs");
  
  // Process images FIRST
  const imageRegex = /(https?:\/\/[^\s<>"{}|\\^`[\]]+\.(?:jpg|jpeg|png|gif|webp|bmp)(?:\?[^\s<>"{}|\\^`[\]]*)?)/gi;
  agentText = agentText.replace(imageRegex, (match) => {
    console.log("Converting image:", match);
    return `<div style="margin: 10px 0; text-align: center;">
      <img src="${match}" style="max-width: 100%; height: auto; border-radius: 10px;" alt="Bild" />
    </div>`;
  });

  // Process YouTube videos SECOND
  const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/gi;
  agentText = agentText.replace(youtubeRegex, (match, videoId) => {
    console.log("Converting YouTube video:", videoId);
    return `<div style="margin: 10px 0; border-radius: 10px; overflow: hidden;">
      <iframe width="100%" height="200" src="https://www.youtube.com/embed/${videoId}" 
        frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
        allowfullscreen style="border-radius: 10px;"></iframe>
    </div>`;
  });

  return agentText;
}

// =============================================================================
// SOLAR SYSTEMS CAROUSEL FUNCTIONALITY
// =============================================================================

// Handle category change in selector dropdown
function handleCategoryChange(category) {
  if (!category) return;

  const wrapper = document.getElementById("carouselWrapper");
  wrapper.innerHTML = `
    <div style="text-align: center; padding: 20px;">
      <div style="width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-green); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px;"></div>
      <p style="color: var(--text-light); font-size: 1rem; font-weight: 500;">Laddar soll√∂sningar...</p>
    </div>
  `;

  loadSolarSystemsFromN8N(category);
}

// Load solar systems from n8n based on category
async function loadSolarSystemsFromN8N(category) {
  try {
    const response = await fetch(AGENT_URL, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({
        chatInput: `Gallery: ${category}`
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    let solarSystems = [];

    // Parse n8n response
    if (Array.isArray(data) && data[0]?.output) {
      solarSystems = JSON.parse(data[0].output);
    } else if (data?.output) {
      solarSystems = JSON.parse(data.output);
    } else if (Array.isArray(data)) {
      solarSystems = data;
    }

    const validSystems = solarSystems.filter(system => system?.name && system?.image);
    
    if (validSystems.length > 0) {
      createCarousel(validSystems, category);
    } else {
      showNoSystemsMessage(category);
    }

  } catch (error) {
    console.error("Error loading solar systems:", error);
    showErrorMessage();
  }
}

// Create Bootstrap carousel with solar systems - UTAN AUTO-PLAY
function createCarousel(systems, category) {
  if (!systems.length) {
    showNoSystemsMessage(category);
    return;
  }

  const carouselId = "solarCarousel";
  const indicators = systems.map((_, i) => 
    `<button type="button" data-bs-target="#${carouselId}" data-bs-slide-to="${i}" ${i === 0 ? 'class="active" aria-current="true"' : ''}></button>`
  ).join("");

  const slides = systems.map((system, i) => 
    `<div class="carousel-item ${i === 0 ? 'active' : ''}">
      <img src="${system.image}" class="d-block w-100" alt="${system.name}" onclick="handleCardClick('${system.name.replace(/'/g, "\\'")}')" loading="lazy" style="cursor: pointer;">
      <div class="solar-info">
        <div class="solar-name">${system.name}</div>
        <div class="solar-features">
          Fr√•gor? Prata med Emma
        </div>
      </div>
    </div>`
  ).join("");

  // ‚≠ê √ÑNDRING: Tog bort data-bs-ride="carousel" f√∂r att stoppa auto-play
  document.getElementById("carouselWrapper").innerHTML = `
    <div class="success-feedback">
      <i class="fas fa-check-circle"></i> ${systems.length} soll√∂sningar laddade!
    </div>
    <div id="${carouselId}" class="carousel slide solar-carousel">
      <div class="carousel-indicators">${indicators}</div>
      <div class="carousel-inner">${slides}</div>
      <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>
    </div>
  `;

  setTimeout(() => document.querySelector('.success-feedback')?.remove(), 3000);
}

// Handle clicking on a solar system card in carousel
function handleCardClick(systemName) {
  const responseDiv = document.getElementById("agentResponse");
  setLoadingState(responseDiv, true, `Prata med Emma om ${systemName}...`);

  fetch(AGENT_URL, {
    method: "POST",
    headers: { 
      "Content-Type": "application/json",
      "Accept": "application/json"
    },
    body: JSON.stringify({ chatInput: `Information om ${systemName}.` })
  })
  .then(response => response.json())
  .then(result => {
    setLoadingState(responseDiv, false);
    
    const agentText = parseN8nResponse(result);
    const processedText = processUrls(agentText);

    responseDiv.innerHTML = `
      <i class="fas fa-sun" style="color: var(--solar-orange);"></i>
      <span style="margin-left: 10px;">${processedText}</span>
    `;

    document.querySelector('.chat-section').scrollIntoView({ 
      behavior: 'smooth',
      block: 'center'
    });
  })
  .catch(error => {
    console.error("Error:", error);
    setLoadingState(responseDiv, false);
    responseDiv.innerHTML = `
      <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
      <span style="margin-left: 10px;">‚ùå Kunde inte f√• information om ${systemName}. F√∂rs√∂k igen.</span>
    `;
  });
}

// =============================================================================
// CHAT FUNCTIONALITY
// =============================================================================

// Send message to Emma via chat interface
function sendMessage() {
  const input = document.getElementById("chatInput").value.trim();
  if (!input) return;

  const responseDiv = document.getElementById("agentResponse");
  setLoadingState(responseDiv, true, "Emma analyserar din fr√•ga...");

  fetch(AGENT_URL, {
    method: "POST",
    headers: { 
      "Content-Type": "application/json",
      "Accept": "application/json"
    },
    body: JSON.stringify({ chatInput: input })
  })
  .then(response => response.json())
  .then(result => {
    setLoadingState(responseDiv, false);
    
    const agentText = parseN8nResponse(result);
    const processedText = processUrls(agentText);

    responseDiv.innerHTML = `
      <i class="fas fa-sun" style="color: var(--solar-orange);"></i>
      <span style="margin-left: 10px;">${processedText}</span>
    `;
  })
  .catch(error => {
    console.error("Error:", error);
    setLoadingState(responseDiv, false);
    responseDiv.innerHTML = `
      <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
      <span style="margin-left: 10px;">‚ùå Det √§r n√•got fel med ditt meddelande. Prata med Emma f√∂r hj√§lp</span>
    `;
  });

  document.getElementById("chatInput").value = "";
  document.getElementById("chatInput").style.height = 'auto';
}


// =============================================================================
// ERROR HANDLING & FALLBACK DISPLAYS
// =============================================================================

// Show message when no solar systems are found for category
function showNoSystemsMessage(category) {
  document.getElementById("carouselWrapper").innerHTML = `
    <div style="text-align: center; padding: 50px; color: var(--text-light);">
      <i class="fas fa-solar-panel fa-3x" style="color: var(--solar-orange); margin-bottom: 20px;"></i>
      <p style="font-size: 1.1rem; font-weight: 500; margin-bottom: 8px;">Inga soll√∂sningar hittades</p>
      <p style="font-size: 0.9rem; margin-bottom: 20px;">f√∂r kategorin "${category}"</p>
      <button onclick="document.getElementById('productSelector').value=''; document.getElementById('carouselWrapper').innerHTML='';" 
              style="padding: 12px 20px; background: var(--primary-green); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
        V√§lj annan kategori
      </button>
    </div>
  `;
}

// Show error message when connection fails
function showErrorMessage() {
  document.getElementById("carouselWrapper").innerHTML = `
    <div style="text-align: center; padding: 50px; color: var(--text-light);">
      <i class="fas fa-exclamation-triangle fa-3x" style="color: #ef4444; margin-bottom: 20px;"></i>
      <p style="font-size: 1.1rem; font-weight: 500; margin-bottom: 8px;">Anslutningsproblem</p>
      <p style="font-size: 0.9rem; margin-bottom: 20px;">Kunde inte ladda soll√∂sningarna</p>
      <button onclick="location.reload()" 
              style="padding: 12px 20px; background: var(--primary-green); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
        F√∂rs√∂k igen
      </button>
    </div>
  `;
}


// =============================================================================
// CAMERA FUNCTIONALITY
// =============================================================================

// Open camera modal for photo analysis
function openGenericCamera() {
  // Remove any existing modal first
  const existingModal = document.getElementById('camera-modal');
  if (existingModal) {
      existingModal.remove();
  }
  
  // Create new modal with correct structure
  const modal = document.createElement('div');
  modal.id = 'camera-modal';
  modal.className = 'camera-modal active';
  modal.innerHTML = `
      <div class="camera-frame">
          <button class="close-camera-btn" onclick="closeGenericCamera()">‚úï</button>
          <iframe class="camera-iframe" src="generic-camera.html"></iframe>
      </div>
  `;
  
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
}

// Close camera modal
function closeGenericCamera() {
  const modal = document.getElementById('camera-modal');
  if (modal) {
      modal.remove();
  }
  document.body.style.overflow = 'auto';
}

// Listen for camera analysis results from iframe
window.addEventListener('message', function(event) {
  if (event.data && event.data.type === 'emma-message') {
      // Display the camera analysis in Emma's chat
      const responseDiv = document.getElementById("agentResponse");
      responseDiv.innerHTML = `
        <i class="fas fa-sun" style="color: var(--solar-orange);"></i>
        <span style="margin-left: 10px;">${event.data.message}</span>
      `;
      closeGenericCamera();
  } else if (event.data && event.data.type === 'close-camera') {
      closeGenericCamera();
  }
});

// Handle analysis results and add to chat (placeholder function)
function addMessageToChat(sender, message) {
  // REPLACE THIS with your actual chat message function
  console.log(`${sender}: ${message}`);
  
  // Example - adapt to your chat system:
  // const chatContainer = document.querySelector('.chat-messages');
  // const messageDiv = document.createElement('div');
  // messageDiv.className = `message ${sender}`;
  // messageDiv.innerHTML = `<div class="message-bubble">${message}</div>`;
  // chatContainer.appendChild(messageDiv);
  // chatContainer.scrollTop = chatContainer.scrollHeight;
  
  // For now, show as alert (remove this when you connect to your chat)
  alert(`Emma: ${message}`);
}


// =============================================================================
// MODAL INTERACTION HANDLERS
// =============================================================================

// Close modal when clicking outside the camera frame
document.addEventListener('click', function(event) {
  const modal = document.getElementById('camera-modal');
  if (modal && event.target === modal) {
      closeGenericCamera();
  }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
      closeGenericCamera();
  }
});

</script>

// Register service worker for PWA functionality
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js')
      .then(function(registration) {
        console.log('‚úÖ Service Worker registered');
      })
      .catch(function(error) {
        console.log('‚ùå Service Worker failed:', error);
      });
  });
}
</script>

</body>
</html>    